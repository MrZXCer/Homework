<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="database.data.MainMapper">

    <sql id="isPlanActivated">
        (@time >= userplan.activateTime and (ISNULL(userplan.deactivateTime) or userplan.deactivateTime > @time))
    </sql>


    <sql id="first, today, last">
        set @time = #{datetime};
        set @firstSecondOfMonth = convert(last_day(@time - interval 1 month), DATETIME);
        set @lastSecondOfMonth = last_day(@time) + interval 1 day - interval 1 second;

    </sql>

    <select id="getAllPlans" resultType="Plan">
      select * from plan;
    </select>

    <select id="getMyPlans" resultType="Plan">
        select plan.* from plan, userplan
        where userplan.userId = #{userId} and plan.id = userplan.planId;
    </select>

    <select id="orderPlan" resultType="int">
        set @now = NOW();

        insert into userplantransaction(userId, planId, time, action)
        values (#{userId}, #{planId}, @now,
        <choose>
            <when test="activateImmediately">
                'ORDER_IMMEDIATELY'
            </when>
            <otherwise>
                'ORDER_NEXT_MONTH'
            </otherwise>
        </choose>
        );

        set @transactionId = last_insert_id();

        insert into userplan(transactionId, userId, planId, activateTime, orderTime)
        values (@transactionId, #{userId}, #{planId},
        <choose>
            <when test="activateImmediately">
                @now
            </when>
            <otherwise>
                adddate(last_day(@now), 1)
            </otherwise>
        </choose>,
        @now);



        select @transactionId;


    </select>
    <select id="cancelPlan" >
        set @now = NOW();

        select userId, planId into @userId, @id from userplantransaction
        where transactionId=#{transactionId};

        insert into userplantransaction(userId, planId, time, action)
        values (@userId, @id, @now,
        <choose>
            <when test="activateImmediately">
                'CANCEL_IMMEDIATELY'
            </when>
            <otherwise>
                'CANCEL_NEXT_MONTH'
            </otherwise>
        </choose>
        );

        update userplan set deactivateTime =
        <choose>
          <when test="activateImmediately">
            @now
          </when>
          <otherwise>
            adddate(last_day(@now), 1)
          </otherwise>
        </choose>
        where transactionId=#{transactionId};

    </select>


    <insert id="addCallUsage">
        insert into callusage(userId, duration, startTime, endTime)
        values (#{userId}, #{duration}, #{startTime}, #{endTime});
    </insert>

    <insert id="addDataUsage">
        insert into datausage(userId, amount, startTime, endTime, dataType)
        values (#{userId}, #{amount}, #{startTime}, #{endTime}, #{dataType});
    </insert>

    <insert id="addSmsUsage">
        insert into smsusage(userId, time)
        values (#{userId}, #{time});
    </insert>


    <sql id="insideTheMonth">
        between @firstDayOfMonth and @firstDayOfNextMonth
    </sql>

    <sql id="returnsUsage">
        select @limit as `limit`, @total as `total`;
    </sql>

    <select id="getCallUsage" resultType="Usage">
        <include refid="first, today, last"/>
        select sum(duration) into @total from callusage
        where userId=#{userId} and startTime <include refid="insideTheMonth"/>;

        select sum(plan.callMinutes) into @limit from plan, userplan
        where userplan.userId=#{userId} and plan.id = userplan.planId and <include refid="isPlanActivated"/>;

        <include refid="returnsUsage"/>

    </select>

    <select id="getSmsUsage" resultType="Usage">
        <include refid="first, today, last"/>
        select count(*) into @total from smsusage
        where userId=#{userId} and time <include refid="insideTheMonth"/>;

        select sum(plan.sms) into @limit from plan, userplan
        where userplan.userId=#{userId} and plan.id = userplan.planId and <include refid="isPlanActivated"/>;

        <include refid="returnsUsage"/>


    </select>

    <select id="getLocalDataUsage" resultType="Usage">
        <include refid="first, today, last"/>
        select sum(amount) into @total from datausage
        where userId=#{userId} and dataType='LOCAL' and startTime <include refid="insideTheMonth"/>;

        select sum(plan.localData) into @limit from plan, userplan
        where userplan.userId=#{userId} and plan.id = userplan.planId and <include refid="isPlanActivated"/>;

        <include refid="returnsUsage"/>

    </select>

    <select id="getDomesticDataUsage" resultType="Usage">
        <include refid="first, today, last"/>
        select sum(amount) into @total from datausage
        where userId=#{userId} and dataType='DOMESTIC' and startTime <include refid="insideTheMonth"/>;

        select sum(plan.domesticData) into @limit from plan, userplan
        where userplan.userId=#{userId} and plan.id = userplan.planId and <include refid="isPlanActivated"/>;

        <include refid="returnsUsage"/>


    </select>

    <select id="getBasicCost" resultType="BasicCost">
        select basicCostId into @basicCostId from user where id = #{userId};
        select * from basiccost where id = @basicCostId;
    </select>

    <select id="getUser" resultType="User">
        select * from user where id = #{userId};
    </select>

</mapper>